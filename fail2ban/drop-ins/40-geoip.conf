# fail2ban GeoIP Country Whitelisting Jail
# Copyright (c) 2025-2026 Marc Allgeier (fidpa)
# SPDX-License-Identifier: MIT
# https://github.com/fidpa/ubuntu-server-security
#
# Geographic IP filtering for SSH
# Whitelist: DE, AT, CH, NL, FR, BE, LU (DACH + neighbors)
#
# REQUIREMENTS:
#   - geoip-bin package (geoiplookup command)
#   - geoip-database package (country database)
#   - scripts/geoip-whitelist.sh installed to /usr/local/bin/
#
# Installation:
#   sudo apt install geoip-bin geoip-database
#   sudo cp ../scripts/geoip-whitelist.sh /usr/local/bin/
#   sudo chmod 755 /usr/local/bin/geoip-whitelist.sh

[sshd-geoip]
enabled = true
backend = systemd
journalmatch = _SYSTEMD_UNIT=ssh.service + _COMM=sshd
filter = sshd

# Aggressive policy: 1 attempt from non-whitelisted country â†’ 24 hour ban
# Rationale: Legitimate users are in whitelisted countries
maxretry = 1
findtime = 86400
bantime = 86400

# GeoIP whitelist check
# Returns: exit 0 = allow (whitelisted), exit 1 = ban (not whitelisted)
ignorecommand = /usr/local/bin/geoip-whitelist.sh <ip>

# Optional: Telegram alerts with GeoIP context
# Requires: Telegram action configured (see actions/telegram.conf)
# Uncomment to enable:
#action = %(action_)s
#         telegram[name=SSH-GeoIP]
